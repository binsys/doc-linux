Linux 0.11 块设备驱动程序
================================================================================

在 Linux 0.11 内核中主要支持硬盘和软盘驱动器两种块设备。

总体功能:
--------------------------------------------------------------------------------

对硬盘和软盘块设备上数据的读写操作是通过中断处理程序进行的。
每次读写的数据量以一个逻辑块(1024 字节)为单位,而块设备控制器则是以扇区(512字节)为单位。

在处理过程中,使用了读写请求项等待队列来顺序缓冲一次读写多个逻辑块的操作。当程序需要读取硬盘上的
一个逻辑块时,就会向缓冲区管理程序提出申请,而程序的进程则进入睡眠等待状态。缓冲区管理程序首先在
缓冲区中寻找以前是否已经读取过这块数据。如果缓冲区中已经有了,就直接将对应的缓冲区块头指针返回给
程序并唤醒该程序进程。若缓冲区中不存在所要求的数据块,则缓冲管理程序就会调用本章中的低级块读写
函数ll_rw_block(),向相应的块设备驱动程序发出一个读数据块的操作请求。该函数就会为此创建一个请求结构
项,并插入请求队列中。为了提供读写磁盘的效率,减小磁头移动的距离,在插入请求项时使用了电梯移动算法。

当对应的块设备的请求项队列空时,表明此刻该块设备不忙。于是内核就会立刻向该块设备的控制
器发出读数据命令。当块设备的控制器将数据读入到指定的缓冲块中后,就会发出中断请求信号,并调
用相应的读命令后处理函数,处理继续读扇区操作或者结束本次请求项的过程。对相应块设备进行关闭操作
和设置该缓冲块数据已经更新标志,最后唤醒等待该块数据的进程。

块设备操作方式:
--------------------------------------------------------------------------------
在系统(内核)与硬盘(块设备)进行IO操作时,需要考虑三个对象之间的交互作用.
它们是: 系统, 控制器和驱动器(例如硬盘或软盘驱动器). 如下图所示：

https://github.com/leeminghao/doc-linux/blob/master/0.11/driver/block_device_control.png

系统可以直接向控制器发送命令或等待控制器发出中断请求; 控制器在接收到命令后就会控制驱动器的操作,
读/写数据或者进行其它操作。因此我们可以把这里控制器发出的中断信号看作是这三者之间的同步操作信号,
所经历的操作步骤为:

1. 首先, 系统指明控制器在执行命令结束而引发的中断过程中应该调用的C函数,然后向块设备控制器发送
   读、写、复位或其它操作命令; 当控制器完成了指定的命令,会发出中断请求信号,引发系统执行块设备
   的中断处理过程,并在其中调用指定的C函数对读/写或其它命令进行命令结束后的处理工作。
