Arm 体系结构
================================================================================

寄存器和处理器模式
--------------------------------------------------------------------------------

### 处理器模式

arm处理器模式如下图所示:

https://github.com/leeminghao/doc-linux/blob/master/arch/arm/arm_cpu_mode.png

CPU的模式可以简单的理解为当前CPU的工作状态.
比如：当前操作系统正在执行用户程序，那么当前CPU工作在用户模式，这时网卡上有数据到达，产生中断信号，
CPU自动切换到一般中断模式下处理网卡数据（普通应用程序没有权限直接访问硬件），处理完网卡数据，
返回到用户模式下继续执行用户程序。

**特权模式**: 除用户模式外，其它模式均为特权模式（Privileged Modes）。

  ARM内部寄存器和一些片内外设在硬件设计上只允许（或者可选为只允许）特权模式下访问。此外，特权模式
  可以自由的切换处理器模式，而用户模式不能直接切换到别的模式。

**异常模式**: 特权模式中除系统（system）模式之外的其他5种模式又统称为异常模式。

  它们除了可以通过在特权下的程序切换进入外，也可以由特定的异常进入。比如硬件产生中断信号进入中断异常
  模式，读取没有权限数据进入中止异常模式，执行未定义指令时进入未定义指令中止异常模式。

  其中管理模式也称为超级用户模式，是为操作系统提供软中断的特有模式，正是由于有了软中断，用户程序才
  可以通过系统调用切换到管理模式。

* 用户模式：

  用户模式是用户程序的工作模式，它运行在操作系统的用户态，它没有权限去操作其它硬件资源，
  只能执行处理自己的数据，也不能切换到其它模式下，要想访问硬件资源或切换到其它模式只能通过
  软中断或产生异常。

* 系统模式：

  系统模式是特权模式，不受用户模式的限制。用户模式和系统模式共用一套寄存器，操作系统在该模式下
  可以方便的访问用户模式的寄存器，而且操作系统的一些特权任务可以使用这个模式访问一些受控的资源。

* 一般中断模式：

  一般中断模式也叫普通中断模式，用于处理一般的中断请求，通常在硬件产生中断信号之后自动进入该模式，
  该模式为特权模式，可以自由访问系统硬件资源。

* 快速中断模式：

  快速中断模式是相对一般中断模式而言的，它是用来处理对时间要求比较紧急的中断请求，主要用于高速数据
  传输及通道处理中。

* 管理模式：

   管理模式是CPU上电后默认模式，因此在该模式下主要用来做系统的初始化，软中断处理也在该模式下，
   当用户模式下的用户程序请求使用硬件资源时通过软件中断进入该模式。

* 终止模式：

  中止模式用于支持虚拟内存或存储器保护，当用户程序访问非法地址，没有权限读取的内存地址时，会进入该
  模式，linux下编程时经常出现的segment fault通常都是在该模式下抛出返回的。

* 未定义模式：

  未定义模式用于支持硬件协处理器的软件仿真,CPU在指令的译码阶段不能识别该指令操作时,会进入未定义模式.

### 寄存器

CPU的模式不同，在其对应模式下可以使用的寄存器也不相同, 如下表所示:

https://github.com/leeminghao/doc-linux/blob/master/arch/arm/arm_cpu_mode.png

* R0~R7在所有模式下都可以使用的共有寄存器;

* R8~R12是快速中断模式下私有的寄存器，其它模式下不能使用，之所以叫其快速中断，是因为快速中断模式下，
  这几个私有寄存器里数据在模式切换时可以不用入栈保存。

* 除了用户模式和系统模式共用一组R13，R14，其余每种模式都私有自己的R13，R14.

  因为在每种模式下都有自己的栈空间用于执行程序，在执行程序过程中还要保存返回地址，这样可以保证在
  进入不同模式时，当前模式下栈空间不被破坏。
  比如：网卡因为数据到达，产生了中断进入中断模式，在中断模式下有自己的中断处理例程(ISR), ISR在
  执行时要用到栈空间，因此要使用R13，R14。中断处理完成后，返回用户模式下，要继续执行被网卡中断信号
  中断的执行程序。

**注意**: 用户模式和系统模式为什么要共用一组R13，R14呢?
这是因为，在特权模式下可以自由切换工作模式，但是如果切换到用户模式下，就不能再切换到特权模式了，
这是CPU为操作系统提供的保护机制，但是有的时候就需要切换到用户模式下去使用其R13，R14寄存器，
比如当操作系统的进程进行上下文切换时，如果用户模式和系统模式共用一组寄存器，那么可以切换到系统模式
下（系统模式是特权模式）进行操作。

* 所有R15和CPU同时只能处理一条指令，在取指时，有一个CPSR表示当前CPU的状态即可。