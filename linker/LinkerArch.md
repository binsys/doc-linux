链接器涉及到的体系结构问题
================================================================================

链接器和加载器,以及编译器和汇编器,与体系结构的细节密切相关,这包括硬件体系结构和操作系统对
目标计算机在体系结构方面的约定。

硬件体系结构的两个方面影响到链接器: **程序寻址和指令格式**。链接器需要做的事情之一就是对
数据和指令中的地址及偏移量都要进行修改。两种情况下链接器都必须确保所做的修改符合计算机使用的寻址方式;
当修改指令时还需要进一步确保修改结果不能是无效指令。

应用程序二进制接口
--------------------------------------------------------------------------------

每个操作系统都会为运行在该系统下的应用程序提供应用程序二进制接口(Application Binary Interface)。
ABI 包含了应用程序在这个系统下运行时必须遵守的编程约定。ABI总是包含一系列的系统调用和使用这些
系统调用的方法,以及关于程序可以使用的内存地址和使用机器寄存器的规定。从一个应用程序的角度看,
ABI 既是系统架构的一部分也是硬件体系结构的重点,因此只要违反二者之一的条件约束就会导致程序出现严重错误。
在很多情况下,链接器为了遵守 ABI 的约定需要进行一些重要的工作。

例如,ABI 要求每个应用程序包含一个该程序中各例程使用的所有静态数据的地址表,链接器通常会通过收集所有
链接到程序中的模块的地址信息来创建这个表。ABI 经常会影响链接器的是对标准过程调用的定义.

内存地址
--------------------------------------------------------------------------------

计算机系统都有主存储器。主存总是表现为一块连续的存储空间,每一个存储位置都有一个数字地址。
这个地址从 0 开始,并逐渐增长为某个较大的数字(由地址中的位数决定)。

### 字节顺序和对齐

每个存储位置都是由固定数量的数位(bit)组成的。经过将近 50 年的历史,由 64 位到 1 位组成的计算机存储位置都被设计过,
但现在几乎所有产品化的计算机都使用 8 位(1字节)的地址。由于计算机处理的大多数数据,尤其是程序地址,都是大于8位的,
所以通过将相邻的字节合为一组,计算机同样可以很好的处理 16 位、32 位、64 位或 128 位的数据。

在某些计算机上:

* IBM 和 Motorola,多字节数据的第一个字节(数字地址最低)是高位字节(most significant byte);
* 在其它诸如 DEC 和 Intel 的机器上,第一个字节是低位字节(least significant byte).
沿用"格列佛游记"中的典故,将IBM/Motorola 的字节序策略称为big-endian,而DEC/Intel的字节序策略称为little-endian.

由两种方案的优缺点引起的激烈讨论已经持续了很多年了。由于在两台字节序相同的机器间移植程序要比不同字节序的机器要容易的多,
所以实际中对字节序选择的主要考虑来自于对旧系统的兼容。

新近的很多芯片设计可以支持任何一种字节序,这可以在芯片布线时进行选择,也可以在系统引导时通过编程选择,
甚至某些情况下可以针对每个应用程序进行不同选择。(在这些可切换的芯片上,被加载和存储指令处理的数据的
字节序会发生变化,但是被编码到指令中的常量的字节序是不变的,这是一些可以让链接器作者的工作变得很有趣的细节)

多字节数据通常会被对齐到一些“天生”的边界上。就是说,4 字节的数据必须对齐到4 字节的边界上,
2字节要对齐到2字节的边界上,并以此类推。另一种想法就是任何 N 字节数据的地址至少要有 log 2 (N)个低位为 0。

**注意**: 在某些系统上(Intel X86,DEC VAX,IBM 370/390),引用未对齐数据会付出性能降低的代价,
在另外一些系统上(多数 RISC 芯片),这会导致程序故障。即使在那些引用未对齐数据不会导致故障的系统上,
性能的损失也是非常大的,以至于值得我们花费精力来尽可能保持地址的对齐。

很多处理器同样要求程序指令的对齐。多数 RISC 芯片要求指令必须对齐在 4 字节的边界上。
每种体系结构都定义了一系列的寄存器,这是可以由程序指令直接引用的数量很少的固定长度高速存储区域。

各种体系结构的寄存器数量是变化的,从 x86 架构的 8 个到某些 RISC 设计的 32 个,
寄存器的容量几乎都是和程序地址的大小相同,就是说在一个 32 位地址的系统中寄存器是32位的,
而在具有 64 位地址的系统上,寄存器就是 64 位的了。